/*
Praetor v0.1.1
http://github.com/magnumjs/praetor.js
(c) Michael Glazer
License: MIT
*/
var p=function(){"use strict";function t(t,e,r){var n=Function(e.codeBody);for(var a in e.parms)r[a]="undefined"===r[a]?e.parms[a]:r[a];var i={results:t,params:r},s=n.apply(i);return s?s:i.results}function e(t,r,n){e.setOptions(n,r),e.map(r,t)}var r=function(t,e){for(var n in e)"object"!=typeof t[n]?t[n]=e[n]:"object"==typeof e[n]&&(t[n]=r(t[n],e[n]));return t},n={};n.stores={},n.queries={},n.procs={};var a=function(){return JSON.parse(JSON.stringify(n))}(),i={jsonPathOptions:{}},s={},o={},u="[object Object]",c={}.toString;return e.setOptions=function(t,r){s=t,e.settings(t,r)},e.getOptions=function(){return s},e.settings=function(t){return o=r(i,t)},e.map=function(t,r){return this.state=this.state||{},t&&c.call(t)!==u?(this.state[t]||(this.state[t]=r||JSON.parse(JSON.stringify(a))),this.state[t]):(this.state[e.id]=t||this.state[e.id]||n,this.state[e.id])},e.proc=function(r,n,a,i){var s=n.map(function(t){return JSONPath(e.settings().jsonPathOptions,r,t)}),o={parms:i,codeBody:a};return t(s,o,i)},e.setDataStore=function(t,r,n){e.map(n).stores[t]=r},e.getDataStore=function(t,r){return e.map(r).stores[t]},e.setJsonQuery=function(t,r,n,a){e.map(a).queries[t]={query:r,store:n}},e.getJsonQuery=function(t,r){return e.map(r).queries[t]},e.getJsonQueryResult=function(t,r){var n=e.getJsonQuery(t,r),a=e.getDataStore(n.store,r),i=JSONPath(e.settings().jsonPathOptions,a,n.query);return i},e.setStoredProc=function(t,r,n,a,i){e.map(i).procs[t]={namedQueries:r,codeBody:n,parms:a}},e.getStoredProc=function(t,r){return e.map(r).procs[t]},e.getStoredProcResult=function(r,n,a){var i=e.getStoredProc(r,a),s=[];return s=i.namedQueries.map(function(t){var r={};return r[t]=e.getJsonQueryResult(t,a),r}),t(s,i,n)},e.setState=function(t,r){e.map(t,r)},e.getState=function(t){return JSON.parse(JSON.stringify(e.map(t)))},e}("undefined"!=typeof window?window:{});"undefined"!=typeof module&&null!==module&&module.exports?module.exports=p:"function"==typeof define&&define.amd&&define(function(){return p}),!function(require){"use strict";function push(t,e){return t=t.slice(),t.push(e),t}function unshift(t,e){return e=e.slice(),e.unshift(t),e}function JSONPath(t,e,r){if(!(this instanceof JSONPath))try{return new JSONPath(t,e,r)}catch(n){if(!n.avoidNew)throw n;return n.value}t=t||{};var a=t.hasOwnProperty("json")&&t.hasOwnProperty("path");if(this.resultType=t.resultType&&t.resultType.toLowerCase()||"value",this.flatten=t.flatten||!1,this.wrap=t.hasOwnProperty("wrap")?t.wrap:!0,this.sandbox=t.sandbox||{},t.autostart!==!1){var i=this.evaluate(a?t.json:e,a?t.path:r);if(!i||"object"!=typeof reg)throw{avoidNew:!0,value:i,message:"JSONPath should not be called with 'new'"}}}Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)});var isNode="undefined"!=typeof module&&!!module.exports,vm=isNode?require("vm"):{runInNewContext:function(expr,context){return eval(Object.keys(context).reduce(function(t,e){return"var "+e+"="+JSON.stringify(context[e])+";"+t},expr))}},cache={};JSONPath.prototype.evaluate=function(t,e){var r=this;if(this._obj=t,e&&t&&("value"===this.resultType||"path"===this.resultType)){var n=this._normalize(e);"$"===n[0]&&n.length>1&&n.shift();var a=this._trace(n,t,["$"]);return a=a.filter(function(t){return t&&!t.isParentSelector}),a.length?1!==a.length||this.wrap||Array.isArray(a[0].value)?a.reduce(function(t,e){var n=e[r.resultType];return"path"===r.resultType&&(n=r._asPath(n)),r.flatten&&Array.isArray(n)?t=t.concat(n):t.push(n),t},[]):a[0][this.resultType]||!1:this.wrap?[]:!1}},JSONPath.prototype._normalize=function(t){if(cache[t])return cache[t];var e=[],r=t.replace(/[\['](\??\(.*?\))[\]']/g,function(t,r){return"[#"+(e.push(r)-1)+"]"}).replace(/'?\.'?|\['?/g,";").replace(/(?:;)?(\^+)(?:;)?/g,function(t,e){return";"+e.split("").join(";")+";"}).replace(/;;;|;;/g,";..;").replace(/;$|'?\]|'$/g,""),n=r.split(";").map(function(t){var r=t.match(/#([0-9]+)/);return r&&r[1]?e[r[1]]:t});return cache[t]=n,cache[t]},JSONPath.prototype._asPath=function(t){var e,r,n=t,a="$";for(e=1,r=n.length;r>e;e++)a+=/^[0-9*]+$/.test(n[e])?"["+n[e]+"]":"['"+n[e]+"']";return a},JSONPath.prototype._trace=function(t,e,r){function n(t){o=o.concat(t)}var a=this;if(!t.length)return[{path:r,value:e}];var i=t[0],s=t.slice(1);if("^"===i)return r.length?[{path:r.slice(0,-1),expr:s,isParentSelector:!0}]:[];var o=[];if(e&&e.hasOwnProperty(i))n(this._trace(s,e[i],push(r,i)));else if("*"===i)this._walk(i,s,e,r,function(t,e,r,i,s){n(a._trace(unshift(t,r),i,s))});else if(".."===i)n(this._trace(s,e,r)),this._walk(i,s,e,r,function(t,e,r,i,s){"object"==typeof i[t]&&n(a._trace(unshift("..",r),i[t],push(s,t)))});else if("("===i[0])n(this._trace(unshift(this._eval(i,e,r[r.length],r),s),e,r));else if(0===i.indexOf("?("))this._walk(i,s,e,r,function(t,e,i,s,o){a._eval(e.replace(/^\?\((.*?)\)$/,"$1"),s[t],t,r)&&n(a._trace(unshift(t,i),s,o))});else if(i.indexOf(",")>-1){var u,c;for(u=i.split(","),c=0;c<u.length;c++)n(this._trace(unshift(u[c],s),e,r))}else/^(-?[0-9]*):(-?[0-9]*):?([0-9]*)$/.test(i)&&n(this._slice(i,s,e,r));return o.reduce(function(t,r){return t.concat(r.isParentSelector?a._trace(r.expr,e,r.path):[r])},[])},JSONPath.prototype._walk=function(t,e,r,n,a){var i,s,o;if(Array.isArray(r))for(i=0,s=r.length;s>i;i++)a(i,t,e,r,n);else if("object"==typeof r)for(o in r)r.hasOwnProperty(o)&&a(o,t,e,r,n)},JSONPath.prototype._slice=function(t,e,r,n){if(Array.isArray(r)){var a,i=r.length,s=t.split(":"),o=s[0]&&parseInt(s[0],10)||0,u=s[1]&&parseInt(s[1],10)||i,c=s[2]&&parseInt(s[2],10)||1;o=0>o?Math.max(0,o+i):Math.min(i,o),u=0>u?Math.max(0,u+i):Math.min(i,u);var h=[];for(a=o;u>a;a+=c)h=h.concat(this._trace(unshift(a,e),r,n));return h}},JSONPath.prototype._eval=function(t,e,r,n){if(!this._obj||!e)return!1;t.indexOf("@path")>-1&&(this.sandbox._$_path=this._asPath(n.concat([r])),t=t.replace(/@path/g,"_$_path")),t.indexOf("@")>-1&&(this.sandbox._$_v=e,t=t.replace(/@/g,"_$_v"));try{return vm.runInNewContext(t,this.sandbox)}catch(a){throw console.log(a),Error("jsonPath: "+a.message+": "+t)}},JSONPath.eval=function(t,e,r){return JSONPath(r,t,e)},"undefined"==typeof module?(window.jsonPath={eval:JSONPath.eval},window.JSONPath=JSONPath):module.exports=JSONPath}("undefined"==typeof require?null:require);
