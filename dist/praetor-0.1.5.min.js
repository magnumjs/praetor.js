/* Praeter.js 0.1.5 - Stored Procedures (JS Code blocks) for JSON results via XPath JSON
*
* Copyright (c) 2015 Michael Glazer (https://github.com/magnumjs/praetor.js)
* Licensed under the MIT (MIT-LICENSE.txt) licence.
*/
!function(require){"use strict";function push(t,e){return t=t.slice(),t.push(e),t}function unshift(t,e){return e=e.slice(),e.unshift(t),e}function JSONPath(t,e,r){if(!(this instanceof JSONPath))try{return new JSONPath(t,e,r)}catch(n){if(!n.avoidNew)throw n;return n.value}t=t||{};var a=t.hasOwnProperty("json")&&t.hasOwnProperty("path");if(this.resultType=t.resultType&&t.resultType.toLowerCase()||"value",this.flatten=t.flatten||!1,this.wrap=t.hasOwnProperty("wrap")?t.wrap:!0,this.sandbox=t.sandbox||{},t.autostart!==!1){var o=this.evaluate(a?t.json:e,a?t.path:r);if(!o||"object"!=typeof reg)throw{avoidNew:!0,value:o,message:"JSONPath should not be called with 'new'"}}}Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)});var isNode="undefined"!=typeof module&&!!module.exports,vm=isNode?require("vm"):{runInNewContext:function(expr,context){return eval(Object.keys(context).reduce(function(t,e){return"var "+e+"="+JSON.stringify(context[e])+";"+t},expr))}},cache={};JSONPath.prototype.evaluate=function(t,e){var r=this;if(this._obj=t,e&&t&&("value"===this.resultType||"path"===this.resultType)){var n=this._normalize(e);"$"===n[0]&&n.length>1&&n.shift();var a=this._trace(n,t,["$"]);return a=a.filter(function(t){return t&&!t.isParentSelector}),a.length?1!==a.length||this.wrap||Array.isArray(a[0].value)?a.reduce(function(t,e){var n=e[r.resultType];return"path"===r.resultType&&(n=r._asPath(n)),r.flatten&&Array.isArray(n)?t=t.concat(n):t.push(n),t},[]):a[0][this.resultType]||!1:this.wrap?[]:!1}},JSONPath.prototype._normalize=function(t){if(cache[t])return cache[t];var e=[],r=t.replace(/[\['](\??\(.*?\))[\]']/g,function(t,r){return"[#"+(e.push(r)-1)+"]"}).replace(/'?\.'?|\['?/g,";").replace(/(?:;)?(\^+)(?:;)?/g,function(t,e){return";"+e.split("").join(";")+";"}).replace(/;;;|;;/g,";..;").replace(/;$|'?\]|'$/g,""),n=r.split(";").map(function(t){var r=t.match(/#([0-9]+)/);return r&&r[1]?e[r[1]]:t});return cache[t]=n,cache[t]},JSONPath.prototype._asPath=function(t){var e,r,n=t,a="$";for(e=1,r=n.length;r>e;e++)a+=/^[0-9*]+$/.test(n[e])?"["+n[e]+"]":"['"+n[e]+"']";return a},JSONPath.prototype._trace=function(t,e,r){function n(t){s=s.concat(t)}var a=this;if(!t.length)return[{path:r,value:e}];var o=t[0],i=t.slice(1);if("^"===o)return r.length?[{path:r.slice(0,-1),expr:i,isParentSelector:!0}]:[];var s=[];if(e&&e.hasOwnProperty(o))n(this._trace(i,e[o],push(r,o)));else if("*"===o)this._walk(o,i,e,r,function(t,e,r,o,i){n(a._trace(unshift(t,r),o,i))});else if(".."===o)n(this._trace(i,e,r)),this._walk(o,i,e,r,function(t,e,r,o,i){"object"==typeof o[t]&&n(a._trace(unshift("..",r),o[t],push(i,t)))});else if("("===o[0])n(this._trace(unshift(this._eval(o,e,r[r.length],r),i),e,r));else if(0===o.indexOf("?("))this._walk(o,i,e,r,function(t,e,o,i,s){a._eval(e.replace(/^\?\((.*?)\)$/,"$1"),i[t],t,r)&&n(a._trace(unshift(t,o),i,s))});else if(o.indexOf(",")>-1){var u,c;for(u=o.split(","),c=0;c<u.length;c++)n(this._trace(unshift(u[c],i),e,r))}else/^(-?[0-9]*):(-?[0-9]*):?([0-9]*)$/.test(o)&&n(this._slice(o,i,e,r));return s.reduce(function(t,r){return t.concat(r.isParentSelector?a._trace(r.expr,e,r.path):[r])},[])},JSONPath.prototype._walk=function(t,e,r,n,a){var o,i,s;if(Array.isArray(r))for(o=0,i=r.length;i>o;o++)a(o,t,e,r,n);else if("object"==typeof r)for(s in r)r.hasOwnProperty(s)&&a(s,t,e,r,n)},JSONPath.prototype._slice=function(t,e,r,n){if(Array.isArray(r)){var a,o=r.length,i=t.split(":"),s=i[0]&&parseInt(i[0],10)||0,u=i[1]&&parseInt(i[1],10)||o,c=i[2]&&parseInt(i[2],10)||1;s=0>s?Math.max(0,s+o):Math.min(o,s),u=0>u?Math.max(0,u+o):Math.min(o,u);var h=[];for(a=s;u>a;a+=c)h=h.concat(this._trace(unshift(a,e),r,n));return h}},JSONPath.prototype._eval=function(t,e,r,n){if(!this._obj||!e)return!1;t.indexOf("@path")>-1&&(this.sandbox._$_path=this._asPath(n.concat([r])),t=t.replace(/@path/g,"_$_path")),t.indexOf("@")>-1&&(this.sandbox._$_v=e,t=t.replace(/@/g,"_$_v"));try{return vm.runInNewContext(t,this.sandbox)}catch(a){throw console.log(a),new Error("jsonPath: "+a.message+": "+t)}},JSONPath.eval=function(t,e,r){return JSONPath(r,t,e)},"undefined"==typeof module?(window.jsonPath={eval:JSONPath.eval},window.JSONPath=JSONPath):module.exports=JSONPath}("undefined"==typeof require?null:require);var p=function(t){"use strict";function e(){if("undefined"==typeof JSONPath)throw new Error("JSONPath is required: (https://github.com/s3u/JSONPath)");return JSONPath}function r(t){return JSON.parse(JSON.stringify(t))}function n(e,r){for(var a in r)if("object"!=typeof e[a])e[a]=e[a]===t?r[a]:e[a];else{if(d.call(e[a])==f){delete e[a];continue}e[a]=n(e[a],r[a])}return e}function a(e,r,n){var a=Function(r.code);n=n||{};for(var o in r.parms)n[o]=n[o]===t?r.parms[o]:n[o];var i={results:e,params:n},s=a.apply(i);return s?s:i.results}function o(t,e,r){o.setOptions(r,e);var n=s(o.getState(e),t||{});o.map(e,n)}var i="rootid",s=function(t,e){for(var r in e)if("object"!=typeof t[r])t[r]=e[r];else if("object"==typeof e[r]){if(d.call(e[r])==f){delete t[r];continue}t[r]=s(t[r],e[r])}return t};o.model=function(){return{stores:{},queries:{},procs:{}}};var u={jsonPathOptions:{}},c={},h={},f="[object Null]",p="[object Array]",l="[object String]",d={}.toString;return o.setOptions=function(t,e){c=t,o.settings(t,e)},o.getOptions=function(){return c},o.settings=function(t){return h=s(u,t)},o.map=function(t,e){return this.state=this.state||{},t?(this.state[t]=e||this.state[t]||o.model(),this.state[t]):(this.state[i]=e||this.state[i]||o.model(),this.state[i])},o.procWith=function(t,e,r,n,a){return 1==arguments.length?o.getStoredProcResult(t,id):(o.setJsonQuery(t,r,e,id),void o.setStoredProc(t,t,n,a,id))},o.proc=function(t,r,n,i,s,u){if(1==arguments.length)return o.getStoredProcResult(t);if(t)return o.setStoredProc(t,n,i,s,u);d.call(r)==l&&(r=o.getDataStore(r,u));var c=n.map(function(t){return o.getJsonQuery(t,u)?o.getJsonQueryResult(t,u):e()(o.settings().jsonPathOptions,r,t)}),h={parms:s,code:i};return a(c,h,s)},o.setDataStore=function(t,e,r){o.map(r).stores[t]=e},o.getDataStore=function(t,e){return o.map(e).stores[t]},o.removeDataStore=function(t,e){delete o.map(e).stores[t]},o.emptyDataStore=function(t,e){o.map(e).stores[t]={}},o.setJsonQuery=function(t,e,r,n){o.map(n).queries[t]={query:e,store:r}},o.getJsonQuery=function(t,e){return o.map(e).queries[t]},o.getJsonQueryResult=function(t,r){var n=o.getJsonQuery(t,r),a=o.getDataStore(n.store,r),i=e()(o.settings().jsonPathOptions,a,n.query);return i},o.setStoredProc=function(t,e,r,n,a){o.map(a).procs[t]={queries:d.call(e)==p?e:e.split(","),code:r,parms:n}},o.getStoredProc=function(t,e){return o.map(e).procs[t]},o.getStoredProcResult=function(t,e,r){var n=o.getStoredProc(t,r),i=[];return i=n.queries.map(function(t){var e={};return e[t]=o.getJsonQueryResult(t,r),e}),a(i,n,e)},o.setState=function(t,e){var r=n(t||{},o.model());o.map(e,r)},o.getState=function(t){return r(o.map(t))},o}();"undefined"!=typeof module&&null!==module&&module.exports?(JSONPath=require("JSONPath"),module.exports=p):"function"==typeof define&&define.amd&&define("",["JSONPath"],function(){return p});
//# sourceMappingURL=praetor.min.js.map